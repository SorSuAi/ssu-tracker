<!DOCTYPE html>
<html lang="en">
<head>
    <title>SSU Tracker Pro</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 10px; background: #f0f2f5; color: #333; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 15px; border-top: 5px solid #002147; }
        h2 { color: #002147; margin-bottom: 5px; }
        .mode-container { display: flex; justify-content: space-around; gap: 10px; }
        button { padding: 15px; margin: 5px; font-size: 1em; border-radius: 8px; border: none; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .btn-mode { width: 48%; background: #e0e0e0; }
        .btn-mode.active { background: #002147; color: white; transform: scale(1.02); }
        .btn-action { width: 85%; background: #007bff; color: white; }
        .btn-sync { background: #28a745; color: white; width: 85%; }
        input, select { padding: 12px; width: 85%; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; }
        #status { font-weight: bold; padding: 10px; border-radius: 5px; background: #fff; display: inline-block; margin-top: 10px; }
        .enroll-box { border-top: 5px solid #ffc107; display: none; }
        #searchBar { border: 2px solid #ffc107; }
    </style>
</head>
<body>

    <h2>üèõÔ∏è SSU Tracker Pro</h2>
    
    <div class="card" style="border-top: 5px solid #28a745;">
        <button class="btn-sync" onclick="syncOfflineData()">
            üîÑ Sync Data (<span id="offlineCount">0</span>)
        </button>
        <div id="status">Tap anywhere to start NFC</div>
    </div>

    <div class="card">
        <div class="mode-container">
            <button id="btnAttendance" class="btn-mode active" onclick="setMode('Attendance')">Attendance</button>
            <button id="btnRecitation" class="btn-mode" onclick="setMode('Recitation')">Recitation</button>
        </div>
        <div style="margin-top: 15px;">
            <input type="checkbox" id="enrollToggle" onclick="toggleEnrollmentUI()"> 
            <label for="enrollToggle"><b>Enrollment Mode</b> (Map NFC)</label>
        </div>
    </div>

    <div class="card enroll-box" id="enrollmentUI">
        <h3>Assign NFC to Student</h3>
        <input type="text" id="searchBar" placeholder="üîç Search student name..." onkeyup="filterStudents()">
        <select id="studentSelector" size="5" style="height: 150px;">
            <option value="">-- Start searching or refresh --</option>
        </select>
        <button onclick="fetchStudentList()" style="background:#6c757d; color:white; width:85%; margin-top:10px;">üîÑ Refresh List</button>
    </div>

    <div class="card">
        <input type="text" id="manualId" placeholder="Manual Student ID / Name">
        <button class="btn-action" style="background:#4CAF50;" onclick="submitManual()">Log Entry</button>
    </div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbx5sZG0zIJhkB8P6LjKolCrwXXuDzfsrYWU8enK4Ln_cZS9UwcBX__PHLixbYCjnoKJ/exec";
        let currentMode = "Attendance";
        let isEnrolling = false;
        let allUnenrolledStudents = [];

        // 1. DATABASE (IndexedDB)
        const dbReq = indexedDB.open("SSU_Tracker_DB", 1);
        let db;
        dbReq.onupgradeneeded = e => { e.target.result.createObjectStore("outbox", { autoIncrement: true }); };
        dbReq.onsuccess = e => { db = e.target.result; updateOfflineCount(); };

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btnAttendance').className = (mode === 'Attendance' ? 'btn-mode active' : 'btn-mode');
            document.getElementById('btnRecitation').className = (mode === 'Recitation' ? 'btn-mode active' : 'btn-mode');
            playBeep(440, 50);
        }

        function toggleEnrollmentUI() {
            isEnrolling = document.getElementById('enrollToggle').checked;
            document.getElementById('enrollmentUI').style.display = isEnrolling ? 'block' : 'none';
            if (isEnrolling && allUnenrolledStudents.length === 0) fetchStudentList();
        }

        // 2. FETCH DYNAMIC LIST
        async function fetchStudentList() {
            document.getElementById('status').innerText = "Fetching roster...";
            try {
                const res = await fetch(`${scriptURL}?action=fetchList`);
                allUnenrolledStudents = await res.json();
                renderStudentList(allUnenrolledStudents);
                document.getElementById('status').innerText = "Roster updated.";
            } catch (e) { document.getElementById('status').innerText = "Fetch Error"; }
        }

        function renderStudentList(list) {
            const selector = document.getElementById('studentSelector');
            selector.innerHTML = '';
            list.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.name;
                opt.innerText = `${s.name} (${s.section})`;
                selector.appendChild(opt);
            });
        }

        function filterStudents() {
            const term = document.getElementById('searchBar').value.toLowerCase();
            const filtered = allUnenrolledStudents.filter(s => s.name.toLowerCase().includes(term));
            renderStudentList(filtered);
        }

        // 3. NFC LOGIC
        async function initNFC() {
            if ('NDEFReader' in window) {
                const ndef = new NDEFReader();
                await ndef.scan();
                ndef.onreading = event => {
                    const nfcId = event.serialNumber;
                    if (isEnrolling) { handleEnroll(nfcId); } else { processEntry(nfcId); }
                };
            }
        }

        async function handleEnroll(nfcId) {
            const name = document.getElementById('studentSelector').value;
            if (!name) return alert("Select a student first!");
            document.getElementById('status').innerText = "Mapping...";
            
            try {
                const res = await fetch(scriptURL, { method: "POST", body: JSON.stringify({ name, nfc: nfcId }) });
                alert(await res.text());
                fetchStudentList(); // Remove enrolled student from list
            } catch (e) { alert("Mapping failed. Check connection."); }
        }

        function processEntry(id) {
            let score = (currentMode === "Recitation") ? prompt(`Score for ${id}:`, "1") : "";
            if (currentMode === "Recitation" && score === null) return;
            logData(id, score);
        }

        // 4. OFFLINE SYNC LOGIC
        function logData(id, score) {
            const entry = { id, type: currentMode, score, time: new Date().toISOString() };
            const url = `${scriptURL}?id=${encodeURIComponent(id)}&type=${encodeURIComponent(currentMode)}&score=${encodeURIComponent(score)}`;
            
            fetch(url, { method: "GET", mode: "no-cors" })
                .then(() => { 
                    document.getElementById('status').innerHTML = "‚úÖ Online: " + id;
                    playBeep(880, 150);
                })
                .catch(() => {
                    const store = db.transaction("outbox", "readwrite").objectStore("outbox");
                    store.add(entry);
                    updateOfflineCount();
                    document.getElementById('status').innerHTML = "üì° Offline: Saved Locally";
                    playBeep(440, 200);
                });
        }

        async function syncOfflineData() {
            const store = db.transaction("outbox", "readwrite").objectStore("outbox");
            const records = await new Promise(r => { store.getAll().onsuccess = e => r(e.target.result); });
            
            if (records.length === 0) return alert("Nothing to sync.");
            document.getElementById('status').innerText = "Syncing...";

            for (const rec of records) {
                const url = `${scriptURL}?id=${encodeURIComponent(rec.id)}&type=${encodeURIComponent(rec.type)}&score=${encodeURIComponent(rec.score)}`;
                await fetch(url, { method: "GET", mode: "no-cors" });
            }
            
            db.transaction("outbox", "readwrite").objectStore("outbox").clear();
            updateOfflineCount();
            alert("All data synced to Google Sheets!");
        }

        function updateOfflineCount() {
            const store = db.transaction("outbox", "readonly").objectStore("outbox");
            store.count().onsuccess = e => { document.getElementById('offlineCount').innerText = e.target.result; };
        }

        function playBeep(f, d) {
            const a = new (window.AudioContext || window.webkitAudioContext)();
            const o = a.createOscillator();
            const g = a.createGain();
            o.frequency.value = f;
            o.connect(g); g.connect(a.destination);
            g.gain.value = 0.05;
            o.start(); o.stop(a.currentTime + d/1000);
        }

        function submitManual() {
            const val = document.getElementById('manualId').value;
            if (val) processEntry(val);
        }

        window.addEventListener('click', initNFC, { once: true });
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    </script>
</body>
</html>